rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.role == "admin" ||
        request.auth.token.role == "superadmin" ||
        request.auth.token.role == "partner_admin"
      );
    }

    function isFieldWorker() {
      return isAuthenticated() && (
        request.auth.token.role == "oem_teleoperator" ||
        request.auth.token.role == "location_cleaner"
      );
    }

    function isManager() {
      return isAuthenticated() && (
        request.auth.token.role == "partner_manager" ||
        request.auth.token.role == "location_owner"
      );
    }

    function isOrgUser() {
      return isAuthenticated() && (
        request.auth.token.role == "partner_manager" ||
        request.auth.token.role == "location_owner" ||
        request.auth.token.role == "oem_teleoperator" ||
        request.auth.token.role == "location_cleaner"
      );
    }

    function getOrganizationId() {
      return request.auth.token.organizationId;
    }

    function partnerMatches(partnerOrgId) {
      return isAdmin() ||
        (isAuthenticated() && request.auth.token.partnerId == partnerOrgId);
    }

    // Organizations collection
    match /organizations/{organizationId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isOrgUser() && resource.data.id == getOrganizationId())
      );
      allow write: if isAdmin();
    }

    // Locations collection
    match /locations/{locationId} {
      // Helper: Check if user's org has access to location
      function hasLocationAccess() {
        let userOrgId = getOrganizationId();
        if (!userOrgId) return false;
        
        // Check assignedOrganizations array (new multi-org model)
        let assignedOrgs = resource.data.assignedOrganizations || [];
        if (assignedOrgs.hasAny([userOrgId])) return true;
        
        // Fallback to legacy organizationId field
        return resource.data.organizationId == userOrgId;
      }
      
      // Admins can read all locations
      // Field workers can read locations assigned to their organization
      allow read: if isAdmin() || (
        isFieldWorker() && hasLocationAccess()
      );
      
      // Managers can read locations assigned to their org
      allow read: if isManager() && hasLocationAccess();
      
      // Property owners can read their own locations
      allow read: if isAuthenticated() && 
        (isManager() || resource.data.ownerId == request.auth.uid);
      
      // Admins can write all locations
      allow write: if isAdmin();
      
      // Property owners (location_owner role) can create locations where they are the owner
      allow create: if isAuthenticated() && 
        (request.auth.token.role == "location_owner" || isManager()) &&
        request.resource.data.ownerId == request.auth.uid;
      
      // Property owners can update their own locations
      allow update: if isAuthenticated() && 
        (isManager() || resource.data.ownerId == request.auth.uid);
      
      // Property owners can delete their own locations
      allow delete: if isAuthenticated() && 
        (isManager() || resource.data.ownerId == request.auth.uid);
      
      // Tasks subcollection
      match /tasks/{taskId} {
        // Same rules as location (inherit organization-based access)
        // Tasks accessible if location is accessible to user's org
        allow read: if isAdmin() || (
          isOrgUser() && 
          get(/databases/$(database)/documents/locations/$(locationId)).data.assignedOrganizations.hasAny([getOrganizationId()]) ||
          get(/databases/$(database)/documents/locations/$(locationId)).data.organizationId == getOrganizationId()
        );
        
        allow write: if isAdmin();
        
        // Instructions subcollection
        match /instructions/{instructionId} {
          // Same rules as tasks
          // Instructions accessible if location is accessible
          allow read: if isAdmin() || (
            isOrgUser() && 
            (get(/databases/$(database)/documents/locations/$(locationId)).data.assignedOrganizations.hasAny([getOrganizationId()]) ||
             get(/databases/$(database)/documents/locations/$(locationId)).data.organizationId == getOrganizationId())
          );
          
          allow write: if isAdmin();
        }
      }
    }

    // Teleoperators collection
    match /teleoperators/{teleoperatorId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isOrgUser() && resource.data.organizationId == getOrganizationId())
      );
      allow write: if isAdmin();
    }

    // Task Completions collection
    match /taskCompletions/{completionId} {
      // Org users can read completions for their organization
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isOrgUser() && resource.data.organizationId == getOrganizationId())
      );
      
      // Only field workers can create completions, and only for their organization
      allow create: if isAuthenticated() &&
        isFieldWorker() &&
        request.resource.data.organizationId == getOrganizationId();
      
      // Only admins can update/delete
      allow update, delete: if isAdmin();
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
    }
    
    // Media collection - allow owners to upload for their locations
    match /media/{mediaId} {
      allow read, write: if isAdmin();
      
      // Property owners can create media for their locations
      allow create: if isAuthenticated() && 
        get(/databases/$(database)/documents/locations/$(request.resource.data.locationId)).data.ownerId == request.auth.uid;
      
      // Property owners can read/update/delete media for their locations
      allow read, update, delete: if isAuthenticated() && 
        get(/databases/$(database)/documents/locations/$(resource.data.locationId)).data.ownerId == request.auth.uid;
    }
    
    // Location invites - allow owners to invite cleaners
    match /location_invites/{inviteId} {
      allow read, write: if isAdmin();
      
      // Property owners can create invites for their locations
      allow create: if isAuthenticated() && 
        get(/databases/$(database)/documents/locations/$(request.resource.data.locationId)).data.ownerId == request.auth.uid;
      
      // Property owners can read/manage invites for their locations
      allow read, update, delete: if isAuthenticated() && 
        get(/databases/$(database)/documents/locations/$(resource.data.locationId)).data.ownerId == request.auth.uid;
      
      // Invited users can read their own invites by email
      allow read: if isAuthenticated() && 
        resource.data.invitedEmail == request.auth.token.email;
    }

    // Legacy collections (for backward compatibility)
    match /taskTemplates/{templateId} {
      allow read: if partnerMatches(resource.data.partnerOrgId);
      allow write: if isAdmin();
    }

    match /tasks/{taskId} {
      allow read: if partnerMatches(resource.data.partnerOrgId);
      allow create: if isAdmin();
      allow delete: if isAdmin();
      allow update: if isAdmin();

      match /media/{mediaId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin();
      }
    }

    // Sessions collection (location-based session tracking)
    match /sessions/{sessionId} {
      // Org users can read sessions for their organization
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isOrgUser() && resource.data.organizationId == getOrganizationId())
      );
      
      // Field workers can create their own sessions
      allow create: if isAuthenticated() &&
        isFieldWorker() &&
        request.resource.data.organizationId == getOrganizationId();
      
      // Field workers can update their own sessions
      allow update: if isAuthenticated() &&
        isFieldWorker() &&
        resource.data.organizationId == getOrganizationId();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }

    // Videos collection (mobile app video uploads)
    match /videos/{videoId} {
      // Users can read their own videos
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Admins and managers can read all videos in their org
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isManager() && resource.data.organizationId == getOrganizationId())
      );
      
      // Field workers can create videos for their org's locations
      allow create: if isAuthenticated() &&
        isFieldWorker() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.organizationId == getOrganizationId();
      
      // Field workers can update their own videos (e.g., upload status)
      allow update: if isAuthenticated() &&
        isFieldWorker() &&
        resource.data.userId == request.auth.uid &&
        resource.data.organizationId == getOrganizationId();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }

    // Robot Intelligence collection (synced from SQL, read-only from Firebase)
    match /robot_intelligence/{docId} {
      // OEM partners can read their own organization's data
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (getUserRole() in ['partner_manager', 'oem_teleoperator'] && 
         resource.data.organizationId == getOrganizationId())
      );
      
      // Only admins can write (for sync service)
      allow write: if isAdmin();
    }

    // Sync metadata collection (internal use only)
    match /_sync_metadata/{docId} {
      allow read, write: if isAdmin();
    }

    match /locationNotes/{noteId} {
      allow read: if partnerMatches(resource.data.partnerOrgId);
      allow create: if isAuthenticated()
        && partnerMatches(request.resource.data.partnerOrgId)
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.content is string;
      allow delete: if isAdmin() || request.auth.uid == resource.data.authorId;
    }

    match /auditLogs/{document=**} {
      allow read: if isAdmin();
      allow create: if isAdmin();
    }
  }
}
